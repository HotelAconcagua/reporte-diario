<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Diario</title>
    
    <!-- 
      El CSS se carga aquí. 
      El JavaScript al final de la página cambiará el 'href' a 'dark.css' o 'light.css' 
      según la preferencia guardada o el default.
    -->
    <link id="theme-stylesheet" rel="stylesheet" href="dark.css">
    
    <!-- 
      Estilos base (solo para 'hidden' y estructura mínima).
    -->
    <style>
        .hidden {
            display: none;
        }
        /* Ocultar scrollbar estándar */
        .multiselect-dropdown::-webkit-scrollbar { width: 8px; }
        .multiselect-dropdown::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .multiselect-dropdown::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 10px; }
        .multiselect-dropdown::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* --- CORRECCIÓN DE ICONOS --- */
        /* Ocultar iconos de tema por defecto */
        #theme-sun-icon, #theme-moon-icon { display: none; }
        
        /* Definir tamaño base de los iconos para que no se rompan */
        .icon {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            display: inline-block;
            object-fit: contain;
            vertical-align: middle;
        }
        /* Iconos del tema: mismos tamaños y padding para mantener proporciones iguales */
        #theme-sun-icon, #theme-moon-icon {
            background-color: transparent;
            border-radius: 9999px;
            padding: 0.15rem; /* mismo padding para ambos */
            display: inline-block;
        }
        .multiselect-toggle-icon {
             width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        /* Cuando el sol esté activo, el botón debe tener fondo oscuro completo */
        .button-icon.sun-active {
            background-color: rgba(0,0,0,0.65) !important;
            border-color: rgba(218, 208, 208, 0.158) !important;
            color: #FFFFFF !important;
            box-shadow: none !important;
        }
        /* --- FIN CORRECCIÓN --- */
        /* Header: centrar el título y ajustar logo dentro del header */
        .main-header { position: relative; }
        /* Logo en el header (reemplaza la posición fija anterior) */
        #company-logo {
            width: 48px;
            height: auto;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            border-radius: 6px;
        }
        /* Centrar el título en el header (horizontal y vertical) */
        .main-title {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            z-index: 5;
            text-align: center;
            width: auto;
        }
        @media (max-width: 480px) {
            #company-logo { width: 36px; }
            .main-title { font-size: 1.125rem; }
        }
    </style>
</head>
<body class="bg-fondo">

    <!-- Pantalla de Login -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-container card">
            <h2 class="login-title">Iniciar Sesión</h2>
            <p class="login-subtitle">Introduce tu correo y clave de acceso.</p>
            <div class="login-form">
                <div class="form-group">
                    <label for="login-email" class="form-label">Email</label>
                    <input type="email" id="login-email" class="form-input" placeholder="tu@email.com" value="raicesaconcagua545@gmail.com">
                </div>
                <div class="form-group">
                    <label for="login-password" class="form-label">Clave</label>
                    <input type="password" id="login-password" class="form-input" placeholder="••••••••" value="hotel545">
                </div>
                <p id="login-error" class="form-error hidden">Clave o email incorrectos.</p>
                <button id="login-button" class="button button-primary button-full-width">
                    Entrar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Contenido Principal (Oculto por defecto) -->
    <div id="main-content" class="main-content hidden">
        
        <header class="main-header card">
            <div>
                <!-- Logo colocado en el mismo sitio donde estaba el título -->
                <img id="company-logo" src="logo1.png" alt="Logo empresa" />
                <h1 class="main-title">Registro Diario</h1>
                <div id="user-info" class="user-info-badge status-loading">
                    Cargando usuario...
                </div>
            </div>
            <!-- Botones de Encabezado -->
            <div class="header-buttons">
                <!-- NUEVO: Botón de Tema Sol/Luna -->
                <button id="theme-toggle-btn" class="button-icon" title="Cambiar tema">
                    <!-- Los iconos se mostrarán/ocultarán con JS (usar imágenes pequeñas) -->
                    <img id="theme-sun-icon" class="icon" src="sol.png" alt="Sol" />
                    <img id="theme-moon-icon" class="icon" src="luna.png" alt="Luna" />
                </button>
                <!-- Botón Cerrar Sesión -->
                <button id="logout-button" class="button button-secondary">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd" />
                        <path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943H18.25A.75.75 0 0019 10z" clip-rule="evenodd" />
                    </svg>
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <!-- Formulario de Registro de Novedades -->
        <div class="card">
            <h2 class="card-title">Nueva Novedad</h2>
            <form id="novedad-form" class="form-grid">

                <!-- Prioridad -->
                <div class="form-group">
                    <label for="prioridad" class="form-label">Prioridad</label>
                    <!-- CORRECCIÓN: Clases añadidas a las opciones -->
                    <select id="prioridad" name="prioridad" required class="form-select">
                        <option class="prioridad-urgente-op" value="Urgente">Urgente</option>
                        <option class="prioridad-alta-op" value="Alta">Alta</option>
                        <option class="prioridad-media-op" value="Media" selected>Media</option>
                        <option class="prioridad-baja-op" value="Baja">Baja</option>
                    </select>
                </div>

                <!-- Nº de Reserva -->
                <div class="form-group">
                    <label for="nReserva" class="form-label">Nº de Reserva</label>
                    <input type="text" id="nReserva" name="nReserva" class="form-input" placeholder="Ej: 25016-171152">
                </div>

                <!-- Habitación -->
                <div class="form-group">
                    <label for="habitacion" class="form-label">Habitación</label>
                    <input type="text" id="habitacion" name="habitacion" class="form-input" placeholder="Ej: 319">
                </div>

                <!-- Área/Elemento -->
                <div class="form-group">
                    <label for="areaElemento" class="form-label">Área/Elemento (Requerido)</label>
                    <input type="text" id="areaElemento" name="areaElemento" required class="form-input" placeholder="Ej: Puerta - Mantenimiento">
                </div>

                <!-- Asignado / Notificado a (Multiselect) -->
                <div class="form-group relative">
                    <label for="multiselect-button" class="form-label">Asignado / Notificado a</label>
                    <button type="button" id="multiselect-button" class="multiselect-toggle">
                        <span id="multiselect-label" class="multiselect-label-default">Elige</span>
                        <svg class="multiselect-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <!-- Contenedor del Dropdown -->
                    <div id="multiselect-dropdown-container" class="multiselect-dropdown-container hidden">
                        <div class="multiselect-search-container">
                            <input type="text" id="multiselect-search" class="multiselect-search-input" placeholder="Buscar...">
                        </div>
                        <div class="multiselect-dropdown">
                            <label class="multiselect-option-label">
                                <input type="checkbox" id="multiselect-select-all">
                                <span class="font-semibold">(Seleccionar todo)</span>
                            </label>
                            <!-- Opciones dinámicas -->
                        </div>
                    </div>
                </div>

                <!-- Turno (Automático) -->
                <div class="form-group">
                    <label class="form-label">Turno Actual (Automático)</label>
                    <div id="current-shift" class="turno-display">
                        --:--
                    </div>
                </div>

                <!-- Detalles de la Novedad -->
                <div class="form-group form-group-full">
                    <label for="novedad" class="form-label">Detalles de la Novedad (Requerido)</label>
                    <textarea id="novedad" name="novedad" rows="3" required class="form-textarea" placeholder="Ej: Problemas con la tarjeta de acceso..."></textarea>
                </div>

                <!-- Acciones del Formulario -->
                <div class="form-actions">
                    <button type="submit" id="submit-button" class="button button-primary" disabled>
                        <svg id="loading-spinner" class="loading-spinner hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Registrar Novedad
                    </button>
                </div>
            </form>
        </div>

        <!-- Tabla de Novedades Registradas -->
        <div class="card">
            <h2 class="card-title">Novedades Registradas</h2>
            
            <div class="table-actions">
                <div class="table-buttons-container">
                    <button id="whatsapp-copy-button" class="button button-green" disabled>
                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7.973 1.127l-2.76-2.76a1 1 0 00-1.53.136l-.37.986 1.83 4.956 4.956 1.83.986-.37a1 1 0 00.136-1.53l-2.76-2.76z" clip-rule="evenodd"></path>
                        </svg>
                        Whatsapp (0)
                    </button>
                    <button id="export-button" class="button button-orange" title="Exportar todo el historial a XLSX" disabled>
                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V7.414A2 2 0 0016.586 6L13 2.414A2 2 0 0011.586 2H4zM12 3.5L15.5 7H13a1 1 0 01-1-1V3.5zM7 9h6v2H7V9zm0 4h6v2H7v-2z"></path>
                        </svg>
                        Exportar
                    </button>
                    <button type="button" id="delete-all-btn" class="button button-danger-outline" disabled>
                         <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75V4.5h8V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4.5A1.25 1.25 0 0111.25 3h2.5A1.25 1.25 0 0115 4.25V5.5h-5V4.25zM3.75 6A1.75 1.75 0 002 7.75v7.5A1.75 1.75 0 003.75 17h12.5A1.75 1.75 0 0018 15.25v-7.5A1.75 1.75 0 0016.25 6H3.75zM10 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 10zM13 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0113 10zM7 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 017 10z" clip-rule="evenodd" />
                        </svg>
                        Borrar Todo
                    </button>
                </div>
            </div>

            <!-- Contenedor de tabla -->
            <div class="scrollable-table-container">
                <table class="novedades-table">
                    <thead>
                        <tr>
                            <th>Sel.</th>
                            <th>Turno</th>
                            <th>Fecha</th>
                            <th>Prioridad</th>
                            <th>Área/Elemento</th>
                            <th>Nº Reserva</th>
                            <th>Habit.</th>
                            <th>Novedad</th>
                            <th>Notificado a</th>
                            <th>Estado</th>
                            <th>Editar</th>
                            <th>Borrar</th>
                        </tr>
                    </thead>
                    <tbody id="novedades-log">
                        <!-- Filas de novedades -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Modal de Mensajes -->
    <div id="message-modal" class="modal-overlay hidden">
        <div class="modal-container card">
            <h3 id="modal-title" class="modal-title">Mensaje</h3>
            <p id="modal-content" class="modal-content">Contenido del mensaje.</p>
            <div class="modal-actions">
                <button id="modal-close" class="button button-primary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edición de Novedad (NUEVO) -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-container card" style="max-width: 38rem;">
            <h3 class="modal-title">Editar Novedad</h3>
            <form id="edit-novedad-form" class="form-grid">
                <!-- ID de Novedad Oculto -->
                <input type="hidden" id="edit-novedad-id" name="id">

                <!-- Prioridad -->
                <div class="form-group">
                    <label for="editPrioridad" class="form-label">Prioridad</label>
                    <select id="editPrioridad" name="prioridad" required class="form-select">
                        <option class="prioridad-urgente-op" value="Urgente">Urgente</option>
                        <option class="prioridad-alta-op" value="Alta">Alta</option>
                        <option class="prioridad-media-op" value="Media">Media</option>
                        <option class="prioridad-baja-op" value="Baja">Baja</option>
                    </select>
                </div>

                <!-- Nº de Reserva -->
                <div class="form-group">
                    <label for="editNReserva" class="form-label">Nº de Reserva</label>
                    <input type="text" id="editNReserva" name="nReserva" class="form-input" placeholder="Ej: 25016-171152">
                </div>

                <!-- Habitación -->
                <div class="form-group">
                    <label for="editHabitacion" class="form-label">Habitación</label>
                    <input type="text" id="editHabitacion" name="habitacion" class="form-input" placeholder="Ej: 319">
                </div>
                
                <!-- Área/Elemento -->
                <div class="form-group">
                    <label for="editAreaElemento" class="form-label">Área/Elemento (Requerido)</label>
                    <input type="text" id="editAreaElemento" name="areaElemento" required class="form-input" placeholder="Ej: Puerta - Mantenimiento">
                </div>
                
                <!-- Turno (Solo Lectura) -->
                <div class="form-group">
                    <label class="form-label">Turno (Original)</label>
                    <div id="editCurrentShift" class="turno-display" style="width: 100%;">--:--</div>
                </div>

                <!-- Asignado / Notificado a (Multiselect Corregido) -->
                <div class="form-group relative" style="grid-column: span 3 / span 3;">
                    <label for="edit-multiselect-button" class="form-label">Notificado a</label>
                    <button type="button" id="edit-multiselect-button" class="multiselect-toggle">
                        <span id="edit-multiselect-label" class="multiselect-label-default">Elige</span>
                        <svg class="multiselect-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <!-- Contenedor del Dropdown de Edición -->
                    <div id="edit-multiselect-dropdown-container" class="multiselect-dropdown-container hidden" style="max-width: none;">
                        <div class="multiselect-search-container">
                            <input type="text" id="edit-multiselect-search" class="multiselect-search-input" placeholder="Buscar...">
                        </div>
                        <div id="edit-multiselect-dropdown" class="multiselect-dropdown">
                            <label class="multiselect-option-label">
                                <input type="checkbox" id="edit-multiselect-select-all">
                                <span class="font-semibold">(Seleccionar todo)</span>
                            </label>
                            <!-- Opciones dinámicas de Edición -->
                        </div>
                    </div>
                </div>
                
                <!-- Detalles de la Novedad -->
                <div class="form-group form-group-full">
                    <label for="editNovedad" class="form-label">Detalles de la Novedad (Requerido)</label>
                    <textarea id="editNovedad" name="novedad" rows="3" required class="form-textarea" placeholder="Ej: Problemas con la tarjeta de acceso..."></textarea>
                </div>

                <p id="edit-metadata" class="form-label form-group-full" style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--color-texto-secundario);">
                    Creado por: --
                </p>

                <!-- Acciones del Formulario de Edición -->
                <div class="form-actions" style="margin-top: 0.5rem;">
                    <button type="button" id="cancel-edit-btn" class="button button-gray">Cancelar</button>
                    <button type="submit" id="save-edit-button" class="button button-primary">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal de Confirmación de Borrado (Individual) -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-container card">
            <h3 class="modal-title modal-title-danger">Confirmar Eliminación</h3>
            <p class="modal-content">¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.</p>
            <div class="modal-actions">
                <button id="cancel-delete-btn" class="button button-gray">Cancelar</button>
                <button id="confirm-delete-btn" class="button button-danger" data-id="">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Borrado (Total) -->
    <div id="delete-all-modal" class="modal-overlay hidden">
        <div class="modal-container card">
            <h3 class="modal-title modal-title-danger">Eliminar Todos los Registros</h3>
            <p class="modal-content">¡Atención! Esta acción eliminará **todos** los registros de la base de datos de forma permanente. Esto no se puede deshacer.</p>
            <label for="delete-all-password" class="modal-password-label">Para confirmar, escribe la clave: <code>hotel545</code></label>
            <input type="password" id="delete-all-password" class="modal-password-input" placeholder="Clave de seguridad">
            <p id="delete-all-error" class="modal-error-message hidden">La clave es incorrecta.</p>
            <div class="modal-actions">
                <button id="cancel-delete-all-btn" class="button button-gray">Cancelar</button>
                <button id="confirm-delete-all-btn" class="button button-danger">Eliminar Todo</button>
            </div>
        </div>
    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserSessionPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, 
            orderBy, serverTimestamp, updateDoc, addDoc, 
            setLogLevel, getDocs, deleteDoc, writeBatch 
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // --- Configuración DUAL de Firebase ---
        const isCanvasEnvironment = typeof __app_id !== 'undefined';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hotel-app'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        let firebaseConfig;
        if (isCanvasEnvironment) {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                console.error("Error: Entorno Canvas detectado pero __firebase_config no está definida.");
                firebaseConfig = {}; 
            }
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyBvzV9DTb0VbpgVaymzTa-MYtfXDkdiW_g",
                authDomain: "hotel-manager-system.firebaseapp.com",
                projectId: "hotel-manager-system",
                storageBucket: "hotel-manager-system.appspot.com",
                messagingSenderId: "963620457167",
                appId: "1:963620457167:web:f39693f502e7b75cb745ba"
            };
        }
        // --- Fin Configuración DUAL ---

        let db, auth, userId = null, userEmail = null;
        const COLLECTION_NAME = 'hotel_log'; 
        
        function getCollectionPath() {
            if (isCanvasEnvironment) {
                return `artifacts/${appId}/public/data/${COLLECTION_NAME}`;
            } else {
                return COLLECTION_NAME;
            }
        }

        // --- Referencias del DOM y Estado Global ---
        // Nuevo Formulario
        const form = document.getElementById('novedad-form');
        const submitButton = document.getElementById('submit-button');
        
        // Formulario de Edición (NUEVO)
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-novedad-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editId = document.getElementById('edit-novedad-id');
        const editPrioridad = document.getElementById('editPrioridad');
        const editNReserva = document.getElementById('editNReserva');
        const editHabitacion = document.getElementById('editHabitacion');
        const editAreaElemento = document.getElementById('editAreaElemento');
        const editNovedad = document.getElementById('editNovedad');
        const editCurrentShift = document.getElementById('editCurrentShift');
        const editMetadata = document.getElementById('edit-metadata');


        let novedadesLog = document.getElementById('novedades-log');
        const currentShiftDisplay = document.getElementById('current-shift');
        const userInfoDisplay = document.getElementById('user-info');
        const loadingSpinner = document.getElementById('loading-spinner');
        const whatsappCopyButton = document.getElementById('whatsapp-copy-button');
        const exportButton = document.getElementById('export-button');
        
        // Referencias DOM para Borrado
        const deleteAllButton = document.getElementById('delete-all-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const deleteAllModal = document.getElementById('delete-all-modal');
        const confirmDeleteAllBtn = document.getElementById('confirm-delete-all-btn');
        const cancelDeleteAllBtn = document.getElementById('cancel-delete-all-btn');
        const deleteAllPassword = document.getElementById('delete-all-password');
        const deleteAllError = document.getElementById('delete-all-error');

        // Referencias DOM para Login
        const loginOverlay = document.getElementById('login-overlay');
        const mainContent = document.getElementById('main-content');
        const loginButton = document.getElementById('login-button');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        
        // Referencias DOM para Cambio de Tema
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeStylesheet = document.getElementById('theme-stylesheet');
        const sunIcon = document.getElementById('theme-sun-icon');
        const moonIcon = document.getElementById('theme-moon-icon');

        // Referencias del DOM para Multiselect (Formulario de Creación)
        const multiselectButton = document.getElementById('multiselect-button');
        const multiselectDropdownContainer = document.getElementById('multiselect-dropdown-container');
        const multiselectSearch = document.getElementById('multiselect-search');
        const multiselectDropdown = multiselectDropdownContainer.querySelector('.multiselect-dropdown');
        const multiselectSelectAll = document.getElementById('multiselect-select-all');
        const multiselectLabel = document.getElementById('multiselect-label');
        
        // Referencias del DOM para Multiselect (Formulario de Edición - NUEVO)
        const editMultiselectButton = document.getElementById('edit-multiselect-button');
        const editMultiselectDropdownContainer = document.getElementById('edit-multiselect-dropdown-container');
        const editMultiselectSearch = document.getElementById('edit-multiselect-search');
        const editMultiselectDropdown = document.getElementById('edit-multiselect-dropdown');
        const editMultiselectSelectAll = document.getElementById('edit-multiselect-select-all');
        const editMultiselectLabel = document.getElementById('edit-multiselect-label');

        // CORRECCIÓN: Referencia para Dropdown de Prioridad (Creación)
        const prioridadSelect = document.getElementById('prioridad');
        // CORRECCIÓN: Referencia para Dropdown de Prioridad (Edición)
        const editPrioridadSelect = document.getElementById('editPrioridad');

        const multiselectOptions = [
            'Mantenimiento', 'HSKP', 'ReservasHA', 'ReservasHE', 'Front', 'Jefe Recepción', 
            'Seguridad', 'Parking', 'A.Públicas', 'Piscina', 'GerenciaO', 'GerenciaD'
        ];

        let allNovedadesMap = new Map(); 
        let selectedNovedadIds = new Set(); 
        
        // --- Funciones de Utilidad ---

        function showMessageModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        document.getElementById('modal-close').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
        });

        function calcularTurno() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const totalMinutes = hour * 60 + minute;
            const MANANA_START = 6 * 60 + 30; // 390
            const MANANA_END = 14 * 60 + 30; // 870
            const TARDE_START = 14 * 60 + 31; // 871
            const TARDE_END = 22 * 60 + 30; // 1350

            if (totalMinutes >= MANANA_START && totalMinutes <= MANANA_END) {
                return 'Mañana';
            } else if (totalMinutes >= TARDE_START && totalMinutes <= TARDE_END) {
                return 'Tarde';
            } else {
                return 'Noche';
            }
        }

        // Actualiza el display del turno actual en el DOM
        function updateShiftDisplay() {
            try {
                const turno = calcularTurno();
                if (currentShiftDisplay) {
                    currentShiftDisplay.textContent = turno;
                    // Mostrar hora exacta como tooltip para contexto
                    const now = new Date();
                    currentShiftDisplay.title = `Última actualización: ${now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}`;
                }
            } catch (err) {
                console.error('Error actualizando turno:', err);
            }
        }
        
        function formatDate(date) {
            if (!date || typeof date.toLocaleDateString !== 'function') {
                return 'Fecha Inválida';
            }
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function formatFullTimestamp(date) {
            if (!date || typeof date.toLocaleString !== 'function') {
                return 'Fecha Inválida';
            }
            return date.toLocaleString('es-ES', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getPriorityClasses(prioridad) {
            switch (prioridad) {
                case 'Urgente': return 'badge badge-urgente';
                case 'Alta': return 'badge badge-alta';
                case 'Media': return 'badge badge-media';
                default: return 'badge badge-baja';
            }
        }

        function getStatusClasses(estado) {
            switch (estado) {
                case 'Completado': return 'estado-select status-completado';
                default: return 'estado-select status-encurso';
            }
        }
        
        // Lógica para colorear dropdown de Prioridad (Creación)
        function updatePrioridadColor() {
            if (!prioridadSelect) return;
            const selectedValue = prioridadSelect.value;
            prioridadSelect.classList.remove('prioridad-urgente', 'prioridad-alta', 'prioridad-media', 'prioridad-baja');
            switch (selectedValue) {
                case 'Urgente': prioridadSelect.classList.add('prioridad-urgente'); break;
                case 'Alta': prioridadSelect.classList.add('prioridad-alta'); break;
                case 'Media': prioridadSelect.classList.add('prioridad-media'); break;
                case 'Baja': prioridadSelect.classList.add('prioridad-baja'); break;
            }
        }
        
        // Lógica para colorear dropdown de Prioridad (Edición)
        function updateEditPrioridadColor() {
            if (!editPrioridadSelect) return;
            const selectedValue = editPrioridadSelect.value;
            editPrioridadSelect.classList.remove('prioridad-urgente', 'prioridad-alta', 'prioridad-media', 'prioridad-baja');
            switch (selectedValue) {
                case 'Urgente': editPrioridadSelect.classList.add('prioridad-urgente'); break;
                case 'Alta': editPrioridadSelect.classList.add('prioridad-alta'); break;
                case 'Media': editPrioridadSelect.classList.add('prioridad-media'); break;
                case 'Baja': editPrioridadSelect.classList.add('prioridad-baja'); break;
            }
        }


        function updateWhatsappButton() {
            const count = selectedNovedadIds.size;
            whatsappCopyButton.innerHTML = `
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7.973 1.127l-2.76-2.76a1 1 0 00-1.53.136l-.37.986 1.83 4.956 4.956 1.83.986-.37a1 1 0 00.136-1.53l-2.76-2.76z" clip-rule="evenodd"></path></svg>
                Whatsapp (${count})
            `;
            whatsappCopyButton.disabled = count === 0;
        }

        function handleSelectionChange(id, isChecked) {
            if (isChecked) {
                selectedNovedadIds.add(id);
            } else {
                selectedNovedadIds.delete(id);
            }
            updateWhatsappButton();
        }

        // --- Lógica de la Base de Datos y Autenticación ---

        async function setupAuthAndDB() {
            console.log("--- DEBUG: Iniciando setupAuthAndDB ---");
            console.log(`DEBUG: Entorno Canvas detectado: ${isCanvasEnvironment}`);
            if (isCanvasEnvironment) {
                console.log("DEBUG: Usando configuración de Firebase de Canvas.");
            } else {
                console.log("DEBUG: Usando configuración de Firebase 'hotel-manager-system' (externa).");
            }

            try {
                setLogLevel('debug'); 
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await setPersistence(auth, browserSessionPersistence);
                
                // onAuthStateChanged ahora maneja TODA la lógica post-autenticación
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Usuario ha iniciado sesión
                        userId = user.uid;
                        userEmail = user.email;
                        
                        // Ocultar login, mostrar app
                        loginOverlay.classList.add('hidden');
                        mainContent.classList.remove('hidden');

                        userInfoDisplay.innerHTML = `<strong>Conectado</strong>`;
                        userInfoDisplay.className = 'user-info-badge status-connected';
                        submitButton.disabled = false;
                        
                        listenForNovedades(); 
                        initializeAppComponents(); // Iniciar turno, etc.
                        
                        console.log(`Autenticado como: ${userEmail}`);
                    } else {
                        // Usuario ha cerrado sesión o no está logueado
                        userId = null;
                        userEmail = null;
                        
                        // Mostrar login, ocultar app
                        loginOverlay.classList.remove('hidden');
                        mainContent.classList.add('hidden');
                        
                        console.warn("DEBUG: Estado de autenticación: Desconectado.");
                        userInfoDisplay.innerHTML = `<strong>Error de conexión</strong>`;
                        userInfoDisplay.className = 'user-info-badge status-error';
                        submitButton.disabled = true;
                    }
                });

            } catch (error) {
                console.error("Error al configurar Firebase:", error);
                userInfoDisplay.innerHTML = `<strong>Error de conexión</strong>`;
                userInfoDisplay.className = 'user-info-badge status-error';
                showMessageModal("Error de Conexión", "No se pudo conectar a la base de datos. Verifique la consola para más detalles.");
            }
        }
        
        function listenForNovedades() {
            const collectionPath = getCollectionPath();
            console.log(`DEBUG: Escuchando novedades en la colección: ${collectionPath}`);
            const novedadesRef = collection(db, collectionPath);
            const q = query(novedadesRef, orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const novedades = [];
                allNovedadesMap.clear(); 
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    novedades.push(data);
                    allNovedadesMap.set(doc.id, data); 
                });
                console.log(`DEBUG: Snapshot recibido, ${snapshot.size} documentos cargados.`);

                renderNovedadesLog(novedades);

                if (novedades.length === 0) {
                    exportButton.disabled = true; 
                    deleteAllButton.disabled = true;
                } else {
                    exportButton.disabled = false; 
                    deleteAllButton.disabled = false;
                }
            }, (error) => {
                console.error("Error al escuchar novedades:", error);
                showMessageModal("Error", `Error al cargar novedades: ${error.message}`);
            });
        }
        
        function renderNovedadesLog(novedades) {
            novedadesLog.innerHTML = '';

            novedades.forEach(novedad => {
                const row = document.createElement('tr');
                row.className = 'novedad-row';

                const timestampDate = novedad.timestamp && typeof novedad.timestamp.toDate === 'function' ? novedad.timestamp.toDate() : new Date();
                const fecha = formatDate(timestampDate);
                const hora = timestampDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                // Celda Selección
                const tdSel = document.createElement('td');
                tdSel.className = 'cell-checkbox';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.id = novedad.id;
                checkbox.className = 'novedad-checkbox';
                checkbox.checked = selectedNovedadIds.has(novedad.id);
                tdSel.appendChild(checkbox);
                row.appendChild(tdSel);

                // Turno
                const tdTurno = document.createElement('td');
                tdTurno.className = 'cell-turno';
                tdTurno.textContent = novedad.turno || '';
                row.appendChild(tdTurno);

                // Fecha + Hora
                const tdFecha = document.createElement('td');
                tdFecha.className = 'cell-fecha';
                tdFecha.innerHTML = `${fecha}<br><span class="hora">${hora}</span>`;
                row.appendChild(tdFecha);

                // Prioridad (badge)
                const tdPrior = document.createElement('td');
                tdPrior.className = 'cell-prioridad'; // Clase para control de ancho
                const spanPrior = document.createElement('span');
                spanPrior.className = getPriorityClasses(novedad.prioridad);
                spanPrior.textContent = novedad.prioridad || '';
                tdPrior.appendChild(spanPrior);
                row.appendChild(tdPrior);

                // Área/Elemento
                const tdArea = document.createElement('td');
                tdArea.className = 'cell-area';
                tdArea.textContent = novedad.areaElemento || '-';
                row.appendChild(tdArea);

                // Nº Reserva
                const tdReserva = document.createElement('td');
                tdReserva.className = 'cell-reserva';
                tdReserva.textContent = novedad.nReserva || '-';
                row.appendChild(tdReserva);

                // Habitación
                const tdHabit = document.createElement('td');
                tdHabit.className = 'cell-habitacion';
                tdHabit.textContent = novedad.habitacion || '-';
                row.appendChild(tdHabit);

                // Novedad
                const tdNovedad = document.createElement('td');
                tdNovedad.className = 'cell-novedad';
                tdNovedad.textContent = novedad.novedad || '';
                tdNovedad.title = novedad.novedad || '';
                row.appendChild(tdNovedad);

                // Notificado a
                const tdNot = document.createElement('td');
                tdNot.className = 'cell-notificado';
                tdNot.textContent = novedad.notificadoA || '-';
                row.appendChild(tdNot);

                // Estado (select)
                const tdEstado = document.createElement('td');
                tdEstado.className = 'cell-estado';
                const selectEstado = document.createElement('select');
                selectEstado.dataset.id = novedad.id;
                selectEstado.className = getStatusClasses(novedad.estado);
                
                // Tooltip de "Completado"
                if (novedad.estado === 'Completado' && novedad.completadoPor) {
                    const completadoTimestamp = novedad.completadoEn ? formatFullTimestamp(novedad.completadoEn.toDate()) : '';
                    selectEstado.title = `Completado por ${novedad.completadoPor} el ${completadoTimestamp}`;
                }

                const optEnCurso = document.createElement('option');
                optEnCurso.value = 'En curso';
                optEnCurso.textContent = 'En curso';
                if (novedad.estado === 'En curso') optEnCurso.selected = true;
                
                const optComp = document.createElement('option');
                optComp.value = 'Completado';
                optComp.textContent = 'Completado';
                if (novedad.estado === 'Completado') optComp.selected = true;
                
                selectEstado.appendChild(optEnCurso);
                selectEstado.appendChild(optComp);
                tdEstado.appendChild(selectEstado);
                row.appendChild(tdEstado);
                
                // Editar (NUEVO)
                const tdEdit = document.createElement('td');
                tdEdit.className = 'cell-edit';
                const editBtn = document.createElement('button');
                editBtn.dataset.id = novedad.id;
                editBtn.className = 'button-icon edit-novedad-btn';
                editBtn.title = 'Editar registro';
                // ÍCONO DE LÁPIZ CORREGIDO
                editBtn.innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917V17.5h3.583L16.5 10.917l-3.583-3.584L5.433 13.917zm13.197-6.264a.75.75 0 000-1.06l-2.062-2.062a.75.75 0 00-1.06 0l-1.41 1.41 3.584 3.584 1.41-1.41z"/></svg>`;
                tdEdit.appendChild(editBtn);
                row.appendChild(tdEdit);


                // Borrar (botón)
                const tdDelete = document.createElement('td');
                tdDelete.className = 'cell-delete';
                const delBtn = document.createElement('button');
                delBtn.dataset.id = novedad.id;
                delBtn.className = 'button-icon delete-novedad-btn';
                delBtn.title = 'Eliminar registro';
                delBtn.innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75V4.5h8V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4.5A1.25 1.25 0 0111.25 3h2.5A1.25 1.25 0 0115 4.25V5.5h-5V4.25zM3.75 6A1.75 1.75 0 002 7.75v7.5A1.75 1.75 0 003.75 17h12.5A1.75 1.75 0 0018 15.25v-7.5A1.75 1.75 0 0016.25 6H3.75zM10 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 10zM13 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0113 10zM7 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 017 10z" clip-rule="evenodd" /></svg>`;
                tdDelete.appendChild(delBtn);
                row.appendChild(tdDelete);

                novedadesLog.appendChild(row);
            });
            
            // Re-adjuntar listeners usando delegación (más eficiente)
            setupTableListeners();
        }
        
        // (Función de listeners actualizada para usar Delegación)
        function setupTableListeners() {
            // Clonar el nodo para limpiar listeners anteriores (necesario para la delegación)
            const oldLog = novedadesLog;
            novedadesLog = oldLog.cloneNode(false); // Clonar vacío
            while (oldLog.firstChild) {
                novedadesLog.appendChild(oldLog.firstChild);
            }
            oldLog.parentNode.replaceChild(novedadesLog, oldLog);
            
            // Delegación de eventos para toda la tabla
            novedadesLog.addEventListener('change', (e) => {
                const target = e.target;
                if (target.classList.contains('novedad-checkbox')) {
                    handleSelectionChange(target.dataset.id, target.checked);
                
                } else if (target.classList.contains('estado-select')) {
                    const id = target.dataset.id;
                    const nuevoEstado = target.value;
                    updateEstado(id, nuevoEstado);
                    
                    // Actualizar clase y tooltip
                    target.className = getStatusClasses(nuevoEstado);
                    if (nuevoEstado === 'Completado') {
                        target.title = `Completado por ${userEmail} (ahora)`;
                    } else {
                        target.title = '';
                    }
                }
            });

            novedadesLog.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                
                if (target.classList.contains('delete-novedad-btn')) {
                    const id = target.dataset.id;
                    confirmDeleteBtn.dataset.id = id;
                    confirmModal.classList.remove('hidden');
                } else if (target.classList.contains('edit-novedad-btn')) {
                    const id = target.dataset.id;
                    const novedad = allNovedadesMap.get(id);
                    if (novedad) {
                        openEditModal(novedad);
                    } else {
                        showMessageModal("Error", "No se encontró el registro para editar.");
                    }
                }
            });

            updateWhatsappButton();
        }
        
        // --- Lógica del Modal de Edición (NUEVO) ---
        
        function openEditModal(novedad) {
            editId.value = novedad.id;
            
            // Cargar datos estáticos/simples
            editPrioridad.value = novedad.prioridad || 'Media';
            editNReserva.value = novedad.nReserva || '';
            editHabitacion.value = novedad.habitacion || '';
            editAreaElemento.value = novedad.areaElemento || '';
            editNovedad.value = novedad.novedad || '';
            editCurrentShift.textContent = novedad.turno || '--:--';

            // Cargar Metadatos
            const createdDate = novedad.timestamp && typeof novedad.timestamp.toDate === 'function' ? formatFullTimestamp(novedad.timestamp.toDate()) : 'Fecha Inválida';
            const user = novedad.userEmail || 'Desconocido';
            editMetadata.textContent = `Creado por: ${user} el ${createdDate}`;

            // Aplicar color de prioridad
            updateEditPrioridadColor(); 
            
            // 1. Inicializar Multiselect de Edición
            // Limpiar selección previa y cargar opciones
            populateEditMultiselect(); 
            
            // 2. Preseleccionar opciones
            const selectedOptions = (novedad.notificadoA || '').split(', ').filter(s => s.trim() !== '');
            editMultiselectDropdown.querySelectorAll('.edit-multiselect-option').forEach(cb => {
                cb.checked = selectedOptions.includes(cb.value);
            });

            // 3. Actualizar etiqueta y estado
            updateEditMultiselectLabelAndSelectAll();

            // Mostrar el modal
            editModal.classList.remove('hidden');
        }

        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            updateNovedad();
        });

        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        editPrioridad.addEventListener('change', updateEditPrioridadColor);


        // --- Funciones CRUD ---

        async function addNovedad(data) {
            if (!db || !userId) {
                console.error("DEBUG: addNovedad abortado. DB o UserID no están listos.");
                return;
            }
            submitButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            try {
                const collectionPath = getCollectionPath();
                const novedadesRef = collection(db, collectionPath);
                const newNovedad = {
                    ...data,
                    timestamp: serverTimestamp(),
                    userId: userId, 
                    userEmail: userEmail,
                    estado: 'En curso' 
                };
                await addDoc(novedadesRef, newNovedad);
                form.reset(); 
                resetMultiselect();
                updatePrioridadColor(); // Resetear color de prioridad
            } catch (error) {
                console.error("Error al añadir la novedad:", error);
                showMessageModal("Error", `No se pudo registrar la novedad. Detalles: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        }
        
        async function updateNovedad() {
            if (!db) {
                console.error("DEBUG: updateNovedad abortado. DB no está lista.");
                return;
            }
            
            const id = editId.value;
            if (!id) {
                 showMessageModal("Error", "ID de novedad faltante.");
                return;
            }

            // 1. Obtener opciones seleccionadas del multiselect de edición
            const selectedNotificadoA = [];
            editMultiselectDropdown.querySelectorAll('.edit-multiselect-option:checked').forEach(cb => {
                selectedNotificadoA.push(cb.value);
            });
            
            // 2. Recolectar datos del formulario
            const updatedData = {
                prioridad: editPrioridad.value.trim(),
                nReserva: editNReserva.value.trim() || null,
                habitacion: editHabitacion.value.trim() || null,
                areaElemento: editAreaElemento.value.trim(),
                novedad: editNovedad.value.trim(),
                notificadoA: selectedNotificadoA.join(', ') || null,
                
                // Nota: No actualizamos 'turno' ni 'timestamp' al editar, solo se corrige el contenido.
                // Guardamos quién y cuándo se editó por última vez (para auditoría)
                lastEditedBy: userEmail,
                lastEditedAt: serverTimestamp() 
            };
            
            if (!updatedData.areaElemento || !updatedData.novedad) {
                showMessageModal("Error de Formulario", "Los campos 'Área/Elemento' y 'Detalles de la Novedad' son requeridos.");
                return;
            }

            try {
                const collectionPath = getCollectionPath();
                const docRef = doc(db, collectionPath, id);
                await updateDoc(docRef, updatedData);
                
                editModal.classList.add('hidden');
                showMessageModal("Éxito", "Novedad actualizada correctamente.");
            } catch (error) {
                console.error("Error al actualizar la novedad:", error);
                showMessageModal("Error de Edición", `No se pudo actualizar la novedad. Detalles: ${error.message}`);
            }
        }

        async function updateEstado(id, estado) {
            if (!db) {
                console.error("DEBUG: updateEstado abortado. DB no está lista.");
                return;
            }
            try {
                const collectionPath = getCollectionPath();
                const docRef = doc(db, collectionPath, id);
                
                let updateData = { estado: estado };
                if (estado === 'Completado') {
                    updateData.completadoEn = serverTimestamp();
                    updateData.completadoPor = userEmail;
                }
                
                await updateDoc(docRef, updateData);
                console.log(`DEBUG: Estado de novedad ${id} actualizado a ${estado}`);
            } catch (error) {
                console.error("Error al actualizar el estado:", error);
                showMessageModal("Error de Actualización", `No se pudo cambiar el estado. Detalles: ${error.message}`);
            }
        }

        async function deleteNovedad(id) {
            if (!db) {
                console.error("DEBUG: deleteNovedad abortado. DB no está lista.");
                return;
            }
            try {
                const collectionPath = getCollectionPath();
                const docRef = doc(db, collectionPath, id);
                await deleteDoc(docRef);
                showMessageModal("Éxito", "El registro ha sido eliminado.");
                if (selectedNovedadIds.has(id)) {
                    selectedNovedadIds.delete(id);
                    updateWhatsappButton();
                }
            } catch (error) {
                console.error("Error al eliminar la novedad:", error);
                showMessageModal("Error de Eliminación", `No se pudo eliminar el registro. Detalles: ${error.message}`);
            }
        }

        async function deleteAllNovedades() {
            if (!db) {
                showMessageModal("Error", "La base de datos no está lista.");
                return;
            }
            
            console.log("Iniciando borrado total...");
            confirmDeleteAllBtn.disabled = true;
            confirmDeleteAllBtn.innerText = "Eliminando...";

            try {
                const collectionPath = getCollectionPath();
                const colRef = collection(db, collectionPath);
                const snapshot = await getDocs(colRef);

                if (snapshot.empty) {
                    showMessageModal("Información", "No hay registros para eliminar.");
                    return;
                }

                const docs = snapshot.docs;
                const CHUNK_SIZE = 450;
                for (let i = 0; i < docs.length; i += CHUNK_SIZE) {
                    const chunk = docs.slice(i, i + CHUNK_SIZE);
                    const batch = writeBatch(db);
                    chunk.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    console.log(`DEBUG: Eliminados ${chunk.length} documentos.`);
                }
                
                showMessageModal("Éxito", `Se han eliminado todos los ${docs.length} registros.`);
                selectedNovedadIds.clear();
                updateWhatsappButton();

            } catch (error) {
                console.error("Error al eliminar todas las novedades:", error);
                showMessageModal("Error de Borrado Total", `No se pudieron eliminar los registros. Detalles: ${error.message}`);
            } finally {
                deleteAllModal.classList.add('hidden');
                confirmDeleteAllBtn.disabled = false;
                confirmDeleteAllBtn.innerText = "Eliminar Todo";
                deleteAllPassword.value = "";
                deleteAllError.classList.add('hidden');
            }
        }
        
        // --- Lógica de Inicio ---

        // 1. Lógica de Cambio de Tema
        function applyTheme(theme) {
            if (theme === 'light') {
                themeStylesheet.href = 'light.css';
                moonIcon.style.display = 'block';
                sunIcon.style.display = 'none';
                if (themeToggleBtn) themeToggleBtn.classList.remove('sun-active');
            } else {
                themeStylesheet.href = 'dark.css';
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
                if (themeToggleBtn) themeToggleBtn.classList.add('sun-active');
            }
            // Actualizar color de prioridad al cambiar tema
            updatePrioridadColor();
            updateEditPrioridadColor();
        }

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // Aplicar tema al cargar
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);


        // 2. Lógica de Login
        loginButton.addEventListener('click', async () => {
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginError.classList.add('hidden');
            
            if (!email || !password) {
                loginError.textContent = "Email y clave son requeridos.";
                loginError.classList.remove('hidden');
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargará de mostrar el contenido
            } catch (error) {
                console.error("Error de inicio de sesión:", error.code);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password') {
                    loginError.textContent = "Clave o email incorrectos.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    loginError.textContent = "El inicio por email/clave no está habilitado.";
                } else {
                    loginError.textContent = "Error de conexión.";
                }
                loginError.classList.remove('hidden');
            }
        });
        
        loginPassword.addEventListener('keyup', (e) => {
            loginError.classList.add('hidden');
            if (e.key === 'Enter') {
                loginButton.click();
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
            // onAuthStateChanged se encargará de mostrar el login
        });

        // 3. Inicializar Firebase (esto activa onAuthStateChanged)
        setupAuthAndDB();

        // 4. Componentes de la App (se llaman desde onAuthStateChanged)
        function initializeAppComponents() {
            updateShiftDisplay();
            setInterval(updateShiftDisplay, 60000); 
            
            // Listeners para color de prioridad
            prioridadSelect.addEventListener('change', updatePrioridadColor);
            editPrioridadSelect.addEventListener('change', updateEditPrioridadColor);
            
            // Aplicar color al inicio
            updatePrioridadColor();
            updateEditPrioridadColor();
        }
        
        // 5. Manejo del envío del formulario (Creación)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const selectedNotificadoA = [];
            multiselectDropdown.querySelectorAll('.multiselect-option:checked').forEach(cb => {
                selectedNotificadoA.push(cb.value);
            });
            const data = {
                prioridad: formData.get('prioridad').trim(),
                areaElemento: formData.get('areaElemento').trim(),
                novedad: formData.get('novedad').trim(),
                nReserva: formData.get('nReserva').trim() || null,
                habitacion: formData.get('habitacion').trim() || null,
                notificadoA: selectedNotificadoA.join(', ') || null, 
                turno: calcularTurno() 
            };
            if (!data.areaElemento || !data.novedad) {
                showMessageModal("Error de Formulario", "Los campos 'Área/Elemento' y 'Detalles de la Novedad' son requeridos.");
                return;
            }
            addNovedad(data);
        });

        // 6. Lógica del Botón de Copiar a WhatsApp
        whatsappCopyButton.addEventListener('click', async () => {
            if (selectedNovedadIds.size === 0) {
                showMessageModal("Atención", "Por favor, selecciona al menos una novedad para copiar.");
                return;
            }
            const novedadesByTurno = {};
            const allDisplayedIds = Array.from(novedadesLog.querySelectorAll('.novedad-checkbox')).map(cb => cb.dataset.id);

            for (const id of allDisplayedIds) {
                if (selectedNovedadIds.has(id)) {
                    const data = allNovedadesMap.get(id);
                    const turno = data.turno || 'Sin Turno';
                    if (!novedadesByTurno[turno]) {
                        novedadesByTurno[turno] = [];
                    }
                    novedadesByTurno[turno].push(data);
                }
            }
            const finalMessageParts = [];
            const sortedTurnos = ['Mañana', 'Tarde', 'Noche', 'Sin Turno'].filter(turno => novedadesByTurno[turno]);
            let totalNovedadesCopied = 0;
            for (const turno of sortedTurnos) {
                const novedades = novedadesByTurno[turno];
                finalMessageParts.push(`\n*Novedades Turno ${turno}*\n`); 
                for (const data of novedades) {
                    const area = data.areaElemento || 'N/A';
                    const reserva = data.nReserva || 'S/R';
                    const habitacion = data.habitacion || 'S/H';
                    const novedad = data.novedad || 'Sin descripción';
                    const line = `. ${area} - ${reserva} - ${habitacion} - ${novedad}`;
                    finalMessageParts.push(line);
                    totalNovedadesCopied++;
                }
            }
            const textToCopy = finalMessageParts.join('\n').trim();
            console.log("DEBUG: Texto a copiar a WhatsApp:", textToCopy);
            try {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) {
                    selectedNovedadIds.clear();
                    document.querySelectorAll('.novedad-checkbox').forEach(cb => cb.checked = false);
                    updateWhatsappButton();
                    showMessageModal("Copiado Exitoso", `Se copiaron ${totalNovedadesCopied} novedades con títulos de turno. ¡Listo para pegar en WhatsApp!`);
                } else {
                    throw new Error('Error de copia por fallback.');
                }
            } catch (err) {
                console.error('Error al copiar al portapeles:', err);
                showMessageModal("Error al Copiar", `No se pudo copiar automáticamente.`);
            }
        });

        // 7. Lógica del Botón de Exportar
        function ensureXLSXLoaded() {
            if (window.XLSX) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('No se pudo cargar la librería XLSX'));
                document.head.appendChild(s);
            });
        }
        async function exportAllToXLSX() {
            if (!db) {
                showMessageModal("Error", "La base de datos no está lista. Espera a que la app se conecte.");
                return;
            }
            exportButton.disabled = true;
            exportButton.innerHTML = `<svg class="loading-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Exportando...`;
            try {
                const collectionPath = getCollectionPath();
                const colRef = collection(db, collectionPath);
                const qRef = query(colRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(qRef);
                const rows = [];
                const headers = ['Turno', 'Fecha', 'Hora', 'Prioridad', 'Área/Elemento', 'Nº Reserva', 'Habitación', 'Novedad', 'Notificado a', 'Estado', 'UserId', 'Timestamp', 'CompletadoPor', 'CompletadoEn'];
                rows.push(headers);
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const ts = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate() : (d.timestamp ? new Date(d.timestamp) : new Date());
                    const tsComp = d.completadoEn && d.completadoEn.toDate ? d.completadoEn.toDate() : null;
                    const fecha = formatDate(ts);
                    const hora = ts.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    rows.push([
                        d.turno || '', fecha, hora, d.prioridad || '', d.areaElemento || '',
                        d.nReserva || '', d.habitacion || '', (d.novedad || '').replace(/\r?\n/g, ' '),
                        d.notificadoA || '', d.estado || '', d.userId || '', ts.toISOString(),
                        d.completadoPor || '', tsComp ? tsComp.toISOString() : ''
                    ]);
                });
                await ensureXLSXLoaded();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                const colWidths = [
                    { wch: 10 }, { wch: 12 }, { wch: 8 }, { wch: 10 }, { wch: 25 },
                    { wch: 20 }, { wch: 10 }, { wch: 80 }, { wch: 25 }, { wch: 12 },
                    { wch: 28 }, { wch: 25 }, { wch: 25 }, { wch: 25 }
                ];
                ws['!cols'] = colWidths;
                const wb = { Sheets: { 'Novedades': ws }, SheetNames: ['Novedades'] };
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const fechaParaNombre = `${day}-${month}-${year}`;
                a.href = url;
                a.download = `${fechaParaNombre} - Registro Diario.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showMessageModal("Exportado", `Se exportaron ${rows.length - 1} registros a XLSX. Archivo descargado.`);
            } catch (err) {
                console.error("Error al exportar a XLSX:", err);
                showMessageModal("Error de Exportación", `No se pudo exportar. Detalles: ${err.message}`);
            } finally {
                exportButton.disabled = false;
                exportButton.innerHTML = `
                    <svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V7.414A2 2 0 0016.586 6L13 2.414A2 2 0 0011.586 2H4zM12 3.5L15.5 7H13a1 1 0 01-1-1V3.5zM7 9h6v2H7V9zm0 4h6v2H7v-2z"></path>
                    </svg>
                    Exportar
                `;
            }
        }
        exportButton.addEventListener('click', exportAllToXLSX);

        // 8. Listeners para Modales de Borrado
        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });
        confirmDeleteBtn.addEventListener('click', () => {
            const id = confirmDeleteBtn.dataset.id;
            deleteNovedad(id);
            confirmModal.classList.add('hidden');
        });
        deleteAllButton.addEventListener('click', () => {
            deleteAllPassword.value = '';
            deleteAllError.classList.add('hidden');
            deleteAllModal.classList.remove('hidden');
            deleteAllPassword.focus();
        });
        cancelDeleteAllBtn.addEventListener('click', () => {
            deleteAllModal.classList.add('hidden');
        });
        confirmDeleteAllBtn.addEventListener('click', () => {
            const pass = deleteAllPassword.value;
            if (pass === 'hotel545') {
                deleteAllNovedades();
            } else {
                deleteAllError.classList.remove('hidden');
                deleteAllPassword.focus();
            }
        });

        // 9. Lógica del Dropdown Multiselect (Creación)
        function populateMultiselect() {
            multiselectDropdown.querySelectorAll('.multiselect-option-label').forEach(el => el.remove()); // Corregido el selector
            multiselectOptions.forEach(option => {
                const optionId = `ms-opt-${option.replace(/\s+/g, '-')}`;
                const container = document.createElement('label');
                container.className = 'multiselect-option-label';
                container.setAttribute('for', optionId);
                container.innerHTML = `
                    <input type="checkbox" id="${optionId}" value="${option}" class="multiselect-option">
                    <span>${option}</span>
                `;
                multiselectDropdown.appendChild(container);
            });
            addOptionListeners();
        }
        function addOptionListeners() {
            multiselectDropdown.querySelectorAll('.multiselect-option').forEach(cb => {
                cb.addEventListener('change', updateMultiselectLabelAndSelectAll);
            });
        }
        function updateMultiselectLabelAndSelectAll() {
            const checkedOptions = multiselectDropdown.querySelectorAll('.multiselect-option:checked');
            // Excluir la casilla "Seleccionar todo" de la cuenta total
            const totalOptions = multiselectOptions.length; 
            if (checkedOptions.length === 0) {
                multiselectLabel.textContent = 'Elige';
                multiselectLabel.className = 'multiselect-label-default';
            } else if (checkedOptions.length === totalOptions) {
                multiselectLabel.textContent = 'Todos seleccionados';
                multiselectLabel.className = 'multiselect-label-selected';
            } else if (checkedOptions.length > 2) {
                 multiselectLabel.textContent = `${checkedOptions.length} seleccionados`;
                 multiselectLabel.className = 'multiselect-label-selected';
            } else {
                const labels = Array.from(checkedOptions).map(cb => cb.value).join(', ');
                multiselectLabel.textContent = labels;
                multiselectLabel.className = 'multiselect-label-selected';
            }
            if (checkedOptions.length === totalOptions) {
                multiselectSelectAll.checked = true;
                multiselectSelectAll.indeterminate = false;
            } else if (checkedOptions.length > 0) {
                multiselectSelectAll.checked = false;
                multiselectSelectAll.indeterminate = true;
            } else {
                multiselectSelectAll.checked = false;
                multiselectSelectAll.indeterminate = false;
            }
        }
        function resetMultiselect() {
            multiselectDropdown.querySelectorAll('.multiselect-option:checked').forEach(cb => {
                cb.checked = false;
            });
            multiselectSearch.value = '';
            filterMultiselectOptions();
            updateMultiselectLabelAndSelectAll();
        }
        function filterMultiselectOptions() {
            const filter = multiselectSearch.value.toLowerCase();
            multiselectDropdown.querySelectorAll('.multiselect-option-label').forEach(container => {
                const label = container.querySelector('span').textContent.toLowerCase();
                // Ocultar la opción "Seleccionar todo" del filtro
                if (container.querySelector('#multiselect-select-all')) return; 

                if (label.includes(filter)) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });
        }
        multiselectButton.addEventListener('click', () => {
            multiselectDropdownContainer.classList.toggle('hidden');
            if (!multiselectDropdownContainer.classList.contains('hidden')) {
                multiselectSearch.focus();
            }
        });
        document.addEventListener('click', (e) => {
            if (!multiselectButton.contains(e.target) && !multiselectDropdownContainer.contains(e.target) && !editMultiselectButton.contains(e.target) && !editMultiselectDropdownContainer.contains(e.target)) {
                multiselectDropdownContainer.classList.add('hidden');
                editMultiselectDropdownContainer.classList.add('hidden');
            }
        });
        multiselectSearch.addEventListener('input', filterMultiselectOptions);
        
        // CORRECCIÓN BUG "SELECCIONAR TODO"
        multiselectSelectAll.addEventListener('change', () => {
            const isChecked = multiselectSelectAll.checked;
            multiselectDropdown.querySelectorAll('.multiselect-option').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateMultiselectLabelAndSelectAll();
        });
        // FIN CORRECCIÓN

        // 10. Lógica del Dropdown Multiselect (Edición - NUEVO)
        function populateEditMultiselect() {
            // Limpiar opciones previas (excepto la de Seleccionar todo)
            editMultiselectDropdown.querySelectorAll('.edit-multiselect-option-label').forEach(el => {
                // Asegurarse de no eliminar la etiqueta que contiene el "Seleccionar todo"
                if (!el.querySelector('#edit-multiselect-select-all')) {
                    el.remove();
                }
            }); 
            
            // Recorrer las opciones e insertarlas
            const selectAllLabel = editMultiselectSelectAll.closest('.multiselect-option-label');
            multiselectOptions.forEach(option => {
                const optionId = `edit-ms-opt-${option.replace(/\s+/g, '-')}`;
                const container = document.createElement('label');
                container.className = 'multiselect-option-label edit-multiselect-option-label';
                container.setAttribute('for', optionId);
                container.innerHTML = `
                    <input type="checkbox" id="${optionId}" value="${option}" class="multiselect-option edit-multiselect-option">
                    <span>${option}</span>
                `;
                // Insertar justo después del "Seleccionar todo"
                selectAllLabel.parentNode.insertBefore(container, selectAllLabel.nextSibling);
            });
            addEditOptionListeners();
        }
        function addEditOptionListeners() {
            editMultiselectDropdown.querySelectorAll('.edit-multiselect-option').forEach(cb => {
                cb.addEventListener('change', updateEditMultiselectLabelAndSelectAll);
            });
        }
        function updateEditMultiselectLabelAndSelectAll() {
            const checkedOptions = editMultiselectDropdown.querySelectorAll('.edit-multiselect-option:checked');
            const totalOptions = multiselectOptions.length; // Usamos el array original, no contamos el "Seleccionar todo"
            
            if (checkedOptions.length === 0) {
                editMultiselectLabel.textContent = 'Elige';
                editMultiselectLabel.className = 'multiselect-label-default';
            } else if (checkedOptions.length === totalOptions) {
                editMultiselectLabel.textContent = 'Todos seleccionados';
                editMultiselectLabel.className = 'multiselect-label-selected';
            } else if (checkedOptions.length > 2) {
                 editMultiselectLabel.textContent = `${checkedOptions.length} seleccionados`;
                 editMultiselectLabel.className = 'multiselect-label-selected';
            } else {
                const labels = Array.from(checkedOptions).map(cb => cb.value).join(', ');
                editMultiselectLabel.textContent = labels;
                editMultiselectLabel.className = 'multiselect-label-selected';
            }

            // Manejo de la casilla "Seleccionar todo"
            if (checkedOptions.length === totalOptions) {
                editMultiselectSelectAll.checked = true;
                editMultiselectSelectAll.indeterminate = false;
            } else if (checkedOptions.length > 0) {
                editMultiselectSelectAll.checked = false;
                editMultiselectSelectAll.indeterminate = true;
            } else {
                editMultiselectSelectAll.checked = false;
                editMultiselectSelectAll.indeterminate = false;
            }
        }
        
        editMultiselectButton.addEventListener('click', () => {
            editMultiselectDropdownContainer.classList.toggle('hidden');
            // Esconder el otro multiselect si está abierto
            multiselectDropdownContainer.classList.add('hidden'); 
            if (!editMultiselectDropdownContainer.classList.contains('hidden')) {
                editMultiselectSearch.focus();
            }
        });
        
        editMultiselectSearch.addEventListener('input', () => {
            const filter = editMultiselectSearch.value.toLowerCase();
            editMultiselectDropdown.querySelectorAll('.edit-multiselect-option-label').forEach(container => {
                const label = container.querySelector('span').textContent.toLowerCase();
                if (label.includes(filter)) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });
        });
        
        editMultiselectSelectAll.addEventListener('change', () => {
            const isChecked = editMultiselectSelectAll.checked;
            editMultiselectDropdown.querySelectorAll('.edit-multiselect-option').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateEditMultiselectLabelAndSelectAll();
        });


        // 11. Inicializar Multiselects
        populateMultiselect();
        populateEditMultiselect(); // Inicializar el de Edición

    </script>
</body>
</html>

