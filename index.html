<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Diario</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Estilos personalizados -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        .scrollable-table-container {
            max-height: 70vh; /* Altura máxima para la tabla */
            overflow-y: auto;
        }

        /* Estilos para que la cabecera de la tabla se mantenga fija */
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #4f46e5; /* Color de fondo del encabezado */
            color: white;
            z-index: 10;
        }

        /* Estilos para el dropdown multiselect personalizado */
        .multiselect-dropdown {
            max-height: 200px;
            overflow-y: auto;
        }
        /* Ocultar scrollbar estándar */
        .multiselect-dropdown::-webkit-scrollbar {
            width: 8px;
        }
        /* Estilo del track */
        .multiselect-dropdown::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        /* Estilo del thumb */
        .multiselect-dropdown::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        .multiselect-dropdown::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <header class="mb-8">
            <!-- TÍTULO ACTUALIZADO (Responsive) -->
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 mb-2">Registro Diario</h1>
             <div id="user-info" class="text-sm mt-2 p-2 bg-indigo-100 text-indigo-800 rounded-md font-semibold">
                Cargando usuario...
            </div>
        </header>

        <!-- Formulario de Registro de Novedades -->
        <div class="bg-white p-6 rounded-xl shadow-custom mb-10">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Nueva Novedad</h2>
            <form id="novedad-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Campo de Prioridad -->
                <div>
                    <label for="prioridad" class="block text-sm font-medium text-gray-700">Prioridad</label>
                    <select id="prioridad" name="prioridad" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        <option value="Urgente" class="text-red-700 font-bold">Urgente</option>
                        <option value="Alta" class="text-yellow-600 font-semibold">Alta</option>
                        <option value="Media" selected>Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>

                <!-- Campo Nº de Reserva -->
                <div>
                    <label for="nReserva" class="block text-sm font-medium text-gray-700">Nº de Reserva</label>
                    <input type="text" id="nReserva" name="nReserva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Ej: 25016-171152">
                </div>

                <!-- Campo Habitación -->
                <div>
                    <label for="habitacion" class="block text-sm font-medium text-gray-700">Habitación</label>
                    <input type="text" id="habitacion" name="habitacion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Ej: 319">
                </div>

                <!-- Campo Área/Elemento -->
                <div>
                    <label for="areaElemento" class="block text-sm font-medium text-gray-700">Área/Elemento (Requerido)</label>
                    <input type="text" id="areaElemento" name="areaElemento" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Ej: Puerta - Mantenimiento">
                </div>

                <!-- CAMPO ASIGNADO / NOTIFICADO A (NUEVO DROPDOWN) -->
                <div class="relative">
                    <label for="multiselect-button" class="block text-sm font-medium text-gray-700">Asignado / Notificado a</label>
                    <button type="button" id="multiselect-button" class="mt-1 bg-white relative w-full border border-gray-300 rounded-md shadow-sm p-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                        <span id="multiselect-label" class="block truncate text-gray-500">Elige</span>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </span>
                    </button>
                    <!-- Contenedor del Dropdown -->
                    <div id="multiselect-dropdown-container" class="hidden absolute z-20 mt-1 w-full bg-white shadow-lg rounded-md border border-gray-200">
                        <!-- Buscador -->
                        <div class="p-2">
                            <input type="text" id="multiselect-search" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Buscar...">
                        </div>
                        <!-- Opciones -->
                        <div class="multiselect-dropdown p-2 space-y-1">
                            <!-- Opción "Seleccionar todo" -->
                            <label class="flex items-center px-2 py-1 rounded-md hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" id="multiselect-select-all" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="ml-2 text-sm font-semibold text-gray-900">(Seleccionar todo)</span>
                            </label>
                            <!-- Opciones dinámicas se insertarán aquí -->
                        </div>
                    </div>
                </div>

                <!-- Campo Turno (Automático) -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700">Turno Actual (Automático)</label>
                    <div id="current-shift" class="mt-1 p-2 bg-indigo-50 border border-indigo-200 rounded-md font-semibold text-indigo-700">
                        --:--
                    </div>
                </div>

                <!-- Campo Novedad (Detalles) -->
                <div class="md:col-span-3">
                    <label for="novedad" class="block text-sm font-medium text-gray-700">Detalles de la Novedad (Requerido)</label>
                    <textarea id="novedad" name="novedad" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Ej: Problemas con la tarjeta de acceso a la habitación, la batería está suelta y hace falso contacto."></textarea>
                </div>

                <!-- Botón de Registro -->
                <div class="md:col-span-3 flex justify-end">
                    <button type="submit" id="submit-button" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-md text-sm font-medium rounded-full text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Registrar Novedad
                    </button>
                </div>
            </form>
        </div>

        <!-- Tabla de Novedades Registradas -->
        <div class="bg-white p-6 rounded-xl shadow-custom">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Novedades Registradas</h2>
            
            <!-- CONTROLES DE LOG Y BOTONES -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div id="log-status" class="p-4 bg-yellow-100 text-yellow-800 rounded-md text-center flex-grow w-full md:w-auto hidden">
                    Cargando registros...
                </div>
                <!-- Contenedor para botones (responsive) -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="whatsapp-copy-button" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-full text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7.973 1.127l-2.76-2.76a1 1 0 00-1.53.136l-.37.986 1.83 4.956 4.956 1.83.986-.37a1 1 0 00.136-1.53l-2.76-2.76z" clip-rule="evenodd"></path>
                        </svg>
                        Whatsapp (0 seleccionadas)
                    </button>
                    <!-- Botón Exportar (naranja pastel) -->
                    <button id="export-button" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-full text-orange-800 bg-orange-200 hover:bg-orange-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400 transition duration-150 ease-in-out disabled:opacity-50" title="Exportar todo el historial a XLSX" disabled>
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V7.414A2 2 0 0016.586 6L13 2.414A2 2 0 0011.586 2H4zM12 3.5L15.5 7H13a1 1 0 01-1-1V3.5zM7 9h6v2H7V9zm0 4h6v2H7v-2z"></path>
                        </svg>
                        Exportar
                    </button>
                </div>
            </div>

            <!-- Contenedor de tabla (responsive) -->
            <div class="overflow-x-auto scrollable-table-container rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="sticky-header">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg w-10">Sel.</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">Turno</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-24">Fecha</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-36">Prioridad</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-40">Área/Elemento</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-32">Nº Reserva</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">Habit.</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider min-w-80">Novedad</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-40">Notificado a</th>
                            <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider w-32 rounded-tr-lg">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="novedades-log" class="bg-white divide-y divide-gray-100">
                        <!-- Las filas de novedades se insertarán aquí por JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Modal de Mensajes (Reemplazo de alert()) (Responsive) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-3">Mensaje</h3>
            <p id="modal-content" class="text-sm text-gray-700 mb-4">Contenido del mensaje.</p>
            <div class="flex justify-end">
                <button id="modal-close" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-sm">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        // Importaciones de Firebase (Usando la versión CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, updateDoc, addDoc, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // --- Configuración DUAL de Firebase ---
        const isCanvasEnvironment = typeof __app_id !== 'undefined';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hotel-app'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        let firebaseConfig;
        if (isCanvasEnvironment) {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                console.error("Error: Entorno Canvas detectado pero __firebase_config no está definida.");
                firebaseConfig = {}; 
            }
        } else {
            // --- CORRECCIÓN FINAL ---
            // Esta es la clave que me pasaste en el chat
            firebaseConfig = {
                apiKey: "AIzaSyBvzV9DTb0VbpgVaymzTa-MYtfXDkdiW_g",
                authDomain: "hotel-manager-system.firebaseapp.com",
                projectId: "hotel-manager-system",
                storageBucket: "hotel-manager-system.appspot.com",
                messagingSenderId: "963620457167",
                appId: "1:963620457167:web:f39693f502e7b75cb745ba"
            };
        }
        // --- Fin Configuración DUAL ---

        let db, auth, userId = null;
        const COLLECTION_NAME = 'hotel_log'; 
        
        function getCollectionPath() {
            if (isCanvasEnvironment) {
                return `/artifacts/${appId}/public/data/${COLLECTION_NAME}`;
            } else {
                return COLLECTION_NAME;
            }
        }

        // --- Referencias del DOM y Estado Global ---
        const form = document.getElementById('novedad-form');
        const submitButton = document.getElementById('submit-button');
        const logStatus = document.getElementById('log-status');
        const novedadesLog = document.getElementById('novedades-log');
        const currentShiftDisplay = document.getElementById('current-shift');
        const userInfoDisplay = document.getElementById('user-info');
        const loadingSpinner = document.getElementById('loading-spinner');
        const whatsappCopyButton = document.getElementById('whatsapp-copy-button');
        const exportButton = document.getElementById('export-button');
        
        // --- NUEVO: Referencias del DOM para Multiselect ---
        const multiselectButton = document.getElementById('multiselect-button');
        const multiselectDropdownContainer = document.getElementById('multiselect-dropdown-container');
        const multiselectSearch = document.getElementById('multiselect-search');
        const multiselectDropdown = multiselectDropdownContainer.querySelector('.multiselect-dropdown');
        const multiselectSelectAll = document.getElementById('multiselect-select-all');
        const multiselectLabel = document.getElementById('multiselect-label');

        const multiselectOptions = [
            'Mantenimiento', 'HSKP', 'ReservasHA', 'ReservasHE', 'Jefe Recepción', 
            'Seguridad', 'Parking', 'A.Públicas', 'Piscina', 'GerenciaO', 'GerenciaD'
        ];
        // --- FIN: Referencias Multiselect ---

        let allNovedadesMap = new Map(); 
        let selectedNovedadIds = new Set(); 
        
        // --- Funciones de Utilidad ---

        function showMessageModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        document.getElementById('modal-close').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
        });

        function calcularTurno() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const totalMinutes = hour * 60 + minute;
            const MANANA_START = 6 * 60 + 30; // 390
            const MANANA_END = 14 * 60 + 30; // 870
            const TARDE_START = 14 * 60 + 31; // 871
            const TARDE_END = 22 * 60 + 30; // 1350

            if (totalMinutes >= MANANA_START && totalMinutes <= MANANA_END) {
                return 'Mañana';
            } else if (totalMinutes >= TARDE_START && totalMinutes <= TARDE_END) {
                return 'Tarde';
            } else {
                return 'Noche';
            }
        }
        
        function formatDate(date) {
            if (!date || typeof date.toLocaleDateString !== 'function') {
                return 'Fecha Inválida';
            }
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getPriorityClasses(prioridad) {
            switch (prioridad) {
                case 'Urgente': return 'bg-red-200 text-red-800 font-bold';
                case 'Alta': return 'bg-yellow-200 text-yellow-800 font-semibold';
                case 'Media': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        function getStatusClasses(estado) {
            switch (estado) {
                case 'Completado': return 'bg-green-100 text-green-800 font-medium';
                default: return 'bg-yellow-100 text-yellow-800 font-medium';
            }
        }

        function updateWhatsappButton() {
            const count = selectedNovedadIds.size;
            whatsappCopyButton.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7.973 1.127l-2.76-2.76a1 1 0 00-1.53.136l-.37.986 1.83 4.956 4.956 1.83.986-.37a1 1 0 00.136-1.53l-2.76-2.76z" clip-rule="evenodd"></path></svg>
                Whatsapp (${count} seleccionada${count !== 1 ? 's' : ''})
            `;
            whatsappCopyButton.disabled = count === 0;
        }

        function handleSelectionChange(id, isChecked) {
            if (isChecked) {
                selectedNovedadIds.add(id);
            } else {
                selectedNovedadIds.delete(id);
            }
            updateWhatsappButton();
        }

        function setupTableListeners() {
            document.querySelectorAll('.novedad-checkbox').forEach(checkbox => {
                checkbox.removeEventListener('change', handleSelectionChange); 
                checkbox.addEventListener('change', (e) => handleSelectionChange(e.target.dataset.id, e.target.checked));
            });

            document.querySelectorAll('.estado-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    const nuevoEstado = e.target.value;
                    updateEstado(id, nuevoEstado);
                    e.target.className = `estado-select px-2 py-1 rounded-full text-xs cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 ${getStatusClasses(nuevoEstado)}`;
                });
            });
            updateWhatsappButton();
        }
        
        // --- Lógica de la Base de Datos y Autenticación ---

        async function setupAuthAndDB() {
            // --- INICIO CONSOLE LOGS ---
            console.log("--- DEBUG: Iniciando setupAuthAndDB ---");
            console.log(`DEBUG: Entorno Canvas detectado: ${isCanvasEnvironment}`);
            if (isCanvasEnvironment) {
                console.log("DEBUG: Usando configuración de Firebase de Canvas.");
            } else {
                console.log("DEBUG: Usando configuración de Firebase 'hotel-manager-system' (externa).");
                console.log("DEBUG: Config a usar (Proyecto):", firebaseConfig.projectId);
                console.log("DEBUG: Config a usar (API Key):", firebaseConfig.apiKey);
            }
            // --- FIN CONSOLE LOGS ---

            try {
                setLogLevel('debug'); // Habilitar logs detallados de Firebase
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await setPersistence(auth, browserSessionPersistence);
                
                if (initialAuthToken) { 
                    console.log("DEBUG: Intentando autenticación con Custom Token (Canvas)...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("DEBUG: Intentando autenticación anónima (Externa)...");
                    await signInAnonymously(auth); 
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // --- CAMBIO SOLICITADO ---
                        userInfoDisplay.innerHTML = `<strong>Conectado</strong> (${user.uid})`;
                        userInfoDisplay.classList.remove('bg-indigo-100', 'text-indigo-800', 'bg-red-100', 'text-red-800');
                        userInfoDisplay.classList.add('bg-green-100', 'text-green-800');
                        submitButton.disabled = false;
                        listenForNovedades(); 
                        console.log("Autenticación y DB listas.");
                    } else {
                        userId = null;
                        console.warn("DEBUG: Estado de autenticación: Desconectado.");
                        // --- CAMBIO SOLICITADO (parcial) ---
                        userInfoDisplay.innerHTML = `<strong>Error</strong>`;
                        userInfoDisplay.classList.remove('bg-indigo-100', 'text-indigo-800', 'bg-green-100', 'text-green-800');
                        userInfoDisplay.classList.add('bg-red-100', 'text-red-800');
                        submitButton.disabled = true;
                    }
                });

            } catch (error) {
                // --- INICIO CONSOLE LOGS ---
                console.error("Error al configurar Firebase:", error);
                // --- FIN CONSOLE LOGS ---
                userInfoDisplay.innerHTML = `<strong>Error de Conexión</strong>`;
                userInfoDisplay.classList.remove('bg-indigo-100', 'text-indigo-800', 'bg-green-100', 'text-green-800');
                userInfoDisplay.classList.add('bg-red-100', 'text-red-800');
                showMessageModal("Error de Conexión", "No se pudo conectar a la base de datos. Verifique la consola para más detalles.");
            }
        }

        function listenForNovedades() {
            const collectionPath = getCollectionPath();
            // --- INICIO CONSOLE LOGS ---
            console.log(`DEBUG: Escuchando novedades en la colección: ${collectionPath}`);
            // --- FIN CONSOLE LOGS ---
            const novedadesRef = collection(db, collectionPath);
            
            onSnapshot(novedadesRef, (snapshot) => {
                const novedades = [];
                allNovedadesMap.clear(); 
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    novedades.push(data);
                    allNovedadesMap.set(doc.id, data); 
                });
                // --- INICIO CONSOLE LOGS ---
                console.log(`DEBUG: Snapshot recibido, ${snapshot.size} documentos cargados.`);
                // --- FIN CONSOLE LOGS ---

                novedades.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderNovedadesLog(novedades);

                if (novedades.length === 0) {
                    logStatus.innerHTML = 'Aún no hay novedades registradas.';
                    logStatus.classList.replace('bg-yellow-100', 'bg-blue-100');
                    logStatus.classList.replace('text-yellow-800', 'text-blue-800');
                    logStatus.classList.remove('hidden');
                    exportButton.disabled = true; // Deshabilitar exportar
                } else {
                    logStatus.classList.add('hidden');
                    exportButton.disabled = false; // Habilitar exportar
                }
            }, (error) => {
                console.error("Error al escuchar novedades:", error);
                logStatus.innerHTML = `Error al cargar: ${error.message}`;
                logStatus.classList.replace('bg-yellow-100', 'bg-red-100');
                logStatus.classList.replace('text-yellow-800', 'text-red-800');
                logStatus.classList.remove('hidden');
            });
        }
        
        function renderNovedadesLog(novedades) {
            novedadesLog.innerHTML = ''; 
            
            novedades.forEach(novedad => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const timestampDate = novedad.timestamp ? novedad.timestamp.toDate() : new Date();
                const fecha = formatDate(timestampDate);
                const hora = timestampDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const isChecked = selectedNovedadIds.has(novedad.id) ? 'checked' : '';

                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">
                        <input type="checkbox" data-id="${novedad.id}" class="novedad-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${isChecked}>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${novedad.turno}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600">${fecha}<br><span class="text-xs text-gray-500">${hora}</span></td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs ${getPriorityClasses(novedad.prioridad)}">
                            ${novedad.prioridad}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600">${novedad.areaElemento || '-'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600">${novedad.nReserva || '-'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">${novedad.habitacion || '-'}</td>
                    <td class="px-3 py-3 text-sm text-gray-700 max-w-lg truncate hover:whitespace-normal hover:overflow-visible hover:bg-white hover:shadow-lg transition-all duration-300 cursor-pointer" title="${novedad.novedad}">${novedad.novedad}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600">${novedad.notificadoA || '-'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600">
                        <select data-id="${novedad.id}" class="estado-select px-2 py-1 rounded-full text-xs cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 ${getStatusClasses(novedad.estado)}">
                            <option value="En curso" ${novedad.estado === 'En curso' ? 'selected' : ''} class="bg-white text-yellow-700">En curso</option>
                            <option value="Completado" ${novedad.estado === 'Completado' ? 'selected' : ''} class="bg-white text-green-700">Completado</option>
                        </select>
                    </td>
                `;
                novedadesLog.appendChild(row);
            });
            
            setupTableListeners();
        }

        async function addNovedad(data) {
            if (!db || !userId) {
                console.error("DEBUG: addNovedad abortado. DB o UserID no están listos.");
                return;
            }

            submitButton.disabled = true;
            loadingSpinner.classList.remove('hidden');

            try {
                const collectionPath = getCollectionPath();
                // --- INICIO CONSOLE LOGS ---
                console.log(`DEBUG: Añadiendo documento a: ${collectionPath}`);
                // --- FIN CONSOLE LOGS ---
                const novedadesRef = collection(db, collectionPath);

                const newNovedad = {
                    ...data,
                    timestamp: serverTimestamp(),
                    userId: userId, 
                    estado: 'En curso' 
                };
                
                // --- INICIO CONSOLE LOGS ---
                console.log("DEBUG: Documento a guardar:", newNovedad);
                // --- FIN CONSOLE LOGS ---

                await addDoc(novedadesRef, newNovedad);
                
                console.log("DEBUG: Documento guardado exitosamente.");
                
                form.reset(); 
                // --- NUEVO: Resetear el multiselect ---
                resetMultiselect();
                // --- FIN: Resetear multiselect ---

            } catch (error) {
                console.error("Error al añadir la novedad:", error);
                showMessageModal("Error", `No se pudo registrar la novedad. Detalles: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                loadingSpinner.classList.add('hidden');

            }
        }
        
        async function updateEstado(id, estado) {
            if (!db) {
                console.error("DEBUG: updateEstado abortado. DB no está lista.");
                return;
            }

            try {
                const collectionPath = getCollectionPath();
                const docRef = doc(db, collectionPath, id);
                
                await updateDoc(docRef, {
                    estado: estado
                });
                
                console.log(`DEBUG: Estado de novedad ${id} actualizado a ${estado}`);
            } catch (error) {
                console.error("Error al actualizar el estado:", error);
                showMessageModal("Error de Actualización", `No se pudo cambiar el estado. Detalles: ${error.message}`);
            }
        }
        
        // --- Event Listeners e Inicialización ---

        // 1. Inicialización de Firebase
        setupAuthAndDB();

        // 2. Mostrar el turno actual
        function updateShiftDisplay() {
            currentShiftDisplay.textContent = calcularTurno();
        }
        updateShiftDisplay();
        setInterval(updateShiftDisplay, 60000); 

        // 3. Manejo del envío del formulario
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            
            // --- NUEVO: Obtener valores del multiselect ---
            const selectedNotificadoA = [];
            multiselectDropdown.querySelectorAll('.multiselect-option:checked').forEach(cb => {
                selectedNotificadoA.push(cb.value);
            });
            // --- FIN: Obtener valores ---
            
            const data = {
                prioridad: formData.get('prioridad').trim(),
                areaElemento: formData.get('areaElemento').trim(),
                novedad: formData.get('novedad').trim(),
                nReserva: formData.get('nReserva').trim() || null,
                habitacion: formData.get('habitacion').trim() || null,
                
                // --- NUEVO: Guardar valores ---
                notificadoA: selectedNotificadoA.join(', ') || null, // Unir con comas
                // --- FIN: Guardar valores ---
                
                turno: calcularTurno() 
            };
            
            if (!data.areaElemento || !data.novedad) {
                showMessageModal("Error de Formulario", "Los campos 'Área/Elemento' y 'Detalles de la Novedad' son requeridos.");
                return;
            }

            addNovedad(data);
        });

        // 4. Lógica del Botón de Copiar a WhatsApp
        whatsappCopyButton.addEventListener('click', async () => {
            if (selectedNovedadIds.size === 0) {
                showMessageModal("Atención", "Por favor, selecciona al menos una novedad para copiar.");
                return;
            }

            const novedadesByTurno = {};
            const allDisplayedIds = Array.from(novedadesLog.querySelectorAll('.novedad-checkbox')).map(cb => cb.dataset.id);

            for (const id of allDisplayedIds) {
                if (selectedNovedadIds.has(id)) {
                    const data = allNovedadesMap.get(id);
                    const turno = data.turno || 'Sin Turno';
                    if (!novedadesByTurno[turno]) {
                        novedadesByTurno[turno] = [];
                    }
                    novedadesByTurno[turno].push(data);
                }
            }
            
            const finalMessageParts = [];
            const sortedTurnos = ['Mañana', 'Tarde', 'Noche', 'Sin Turno'].filter(turno => novedadesByTurno[turno]);
            let totalNovedadesCopied = 0;

            for (const turno of sortedTurnos) {
                const novedades = novedadesByTurno[turno];
                finalMessageParts.push(`\n*Novedades Turno ${turno}*\n`); 
                
                for (const data of novedades) {
                    const area = data.areaElemento || 'N/A';
                    const reserva = data.nReserva || 'S/R';
                    const habitacion = data.habitacion || 'S/H';
                    const novedad = data.novedad || 'Sin descripción';
                    
                    const line = `. ${area} - ${reserva} - ${habitacion} - ${novedad}`;
                    finalMessageParts.push(line);
                    totalNovedadesCopied++;
                }
            }

            const textToCopy = finalMessageParts.join('\n').trim();
            
            // --- INICIO CONSOLE LOGS ---
            console.log("DEBUG: Texto a copiar a WhatsApp:", textToCopy);
            // --- FIN CONSOLE LOGS ---
            
            try {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);

                if (successful) {
                    selectedNovedadIds.clear();
                    document.querySelectorAll('.novedad-checkbox').forEach(cb => cb.checked = false);
                    updateWhatsappButton();
                    showMessageModal("Copiado Exitoso", `Se copiaron ${totalNovedadesCopied} novedades con títulos de turno. ¡Listo para pegar en WhatsApp!`);
                } else {
                    throw new Error('Error de copia por fallback.');
                }
            } catch (err) {
                console.error('Error al copiar al portapeles:', err);
                showMessageModal("Error al Copiar", `No se pudo copiar automáticamente. Por favor, copia el siguiente texto manualmente:\n\n${textToCopy}`);
            }
        });

        // --- NUEVO: Exportar TODO el historial a XLSX ordenado por fecha (timestamp desc) ---
        function ensureXLSXLoaded() {
            if (window.XLSX) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
                s.onload = () => resolve();
                s.onerror = (e) => reject(new Error('No se pudo cargar la librería XLSX: ' + e.message));
                document.head.appendChild(s);
            });
        }

        async function exportAllToXLSX() {
            if (!db) {
                showMessageModal("Error", "La base de datos no está lista. Espera a que la app se conecte.");
                return;
            }
            exportButton.disabled = true;
            exportButton.innerText = 'Exportando...';
            try {
                const collectionPath = getCollectionPath();
                const colRef = collection(db, collectionPath);
                const qRef = query(colRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(qRef);

                const rows = [];
                const headers = ['Turno', 'Fecha', 'Hora', 'Prioridad', 'Área/Elemento', 'Nº Reserva', 'Habitación', 'Novedad', 'Notificado a', 'Estado', 'UserId', 'Timestamp'];
                rows.push(headers);

                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const ts = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate() : (d.timestamp ? new Date(d.timestamp) : new Date());
                    const fecha = formatDate(ts);
                    const hora = ts.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                    rows.push([
                        d.turno || '',
                        fecha,
                        hora,
                        d.prioridad || '',
                        d.areaElemento || '',
                        d.nReserva || '',
                        d.habitacion || '',
                        (d.novedad || '').replace(/\r?\n/g, ' '),
                        d.notificadoA || '',
                        d.estado || '',
                        d.userId || '',
                        ts.toISOString()
                    ]);
                });

                await ensureXLSXLoaded();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                
                // --- AJUSTE DE ANCHO DE COLUMNAS (Aprox) ---
                const colWidths = [
                    { wch: 10 }, // Turno
                    { wch: 12 }, // Fecha
                    { wch: 8 },  // Hora
                    { wch: 10 }, // Prioridad
                    { wch: 25 }, // Área/Elemento
                    { wch: 20 }, // Nº Reserva
                    { wch: 10 }, // Habitación
                    { wch: 80 }, // Novedad (más ancha)
                    { wch: 25 }, // Notificado a
                    { wch: 12 }, // Estado
                    { wch: 28 }, // UserId
                    { wch: 25 }  // Timestamp
                ];
                ws['!cols'] = colWidths;
                // --- FIN AJUSTE ---
                
                const wb = { Sheets: { 'Novedades': ws }, SheetNames: ['Novedades'] };
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                // --- CAMBIO DE NOMBRE DE ARCHIVO ---
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0'); // +1 porque los meses son 0-indexados
                const year = now.getFullYear();
                const fechaParaNombre = `${day}-${month}-${year}`;
                
                a.href = url;
                a.download = `${fechaParaNombre} - Registro Diario.xlsx`; // <-- FORMATO SOLICITADO
                // --- FIN CAMBIO ---
                
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                showMessageModal("Exportado", `Se exportaron ${rows.length - 1} registros a XLSX. Archivo descargado.`);
            } catch (err) {
                console.error("Error al exportar a XLSX:", err);
                showMessageModal("Error de Exportación", `No se pudo exportar. Detalles: ${err.message}`);
            } finally {
                exportButton.disabled = false;
                // Restaurar el texto y el icono del botón
                exportButton.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V7.414A2 2 0 0016.586 6L13 2.414A2 2 0 0011.586 2H4zM12 3.5L15.5 7H13a1 1 0 01-1-1V3.5zM7 9h6v2H7V9zm0 4h6v2H7v-2z"></path>
                    </svg>
                    Exportar
                `;
            }
        }

        exportButton.addEventListener('click', exportAllToXLSX);


        // --- NUEVO: Lógica del Dropdown Multiselect ---

        /**
         * Pobla el dropdown con las opciones.
         */
        function populateMultiselect() {
            // Limpiar opciones existentes (excepto "Seleccionar todo")
            multiselectDropdown.querySelectorAll('.multiselect-option-container').forEach(el => el.remove());
            
            multiselectOptions.forEach(option => {
                const optionId = `ms-opt-${option.replace(/\s+/g, '-')}`;
                const container = document.createElement('label');
                container.className = 'multiselect-option-container flex items-center px-2 py-1 rounded-md hover:bg-gray-100 cursor-pointer';
                container.setAttribute('for', optionId);
                
                container.innerHTML = `
                    <input type="checkbox" id="${optionId}" value="${option}" class="multiselect-option h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="ml-2 text-sm text-gray-700">${option}</span>
                `;
                multiselectDropdown.appendChild(container);
            });

            // Añadir listeners a las nuevas opciones
            addOptionListeners();
        }

        /**
         * Añade listeners a los checkboxes de las opciones.
         */
        function addOptionListeners() {
            multiselectDropdown.querySelectorAll('.multiselect-option').forEach(cb => {
                cb.addEventListener('change', updateMultiselectLabelAndSelectAll);
            });
        }

        /**
         * Actualiza el texto del botón (label) y el estado del checkbox "Seleccionar todo".
         */
        function updateMultiselectLabelAndSelectAll() {
            const checkedOptions = multiselectDropdown.querySelectorAll('.multiselect-option:checked');
            const totalOptions = multiselectDropdown.querySelectorAll('.multiselect-option').length;
            
            if (checkedOptions.length === 0) {
                multiselectLabel.textContent = 'Elige';
                multiselectLabel.classList.add('text-gray-500');
                multiselectLabel.classList.remove('text-gray-900', 'font-semibold');
            } else if (checkedOptions.length === totalOptions) {
                multiselectLabel.textContent = 'Todos seleccionados';
                multiselectLabel.classList.remove('text-gray-500');
                multiselectLabel.classList.add('text-gray-900', 'font-semibold');
            } else if (checkedOptions.length > 2) {
                 multiselectLabel.textContent = `${checkedOptions.length} seleccionados`;
                 multiselectLabel.classList.remove('text-gray-500');
                multiselectLabel.classList.add('text-gray-900', 'font-semibold');
            } else {
                // Mostrar los primeros 2 seleccionados
                const labels = Array.from(checkedOptions).map(cb => cb.value).join(', ');
                multiselectLabel.textContent = labels;
                multiselectLabel.classList.remove('text-gray-500');
                multiselectLabel.classList.add('text-gray-900', 'font-semibold');
            }

            // Actualizar el estado de "Seleccionar todo"
            if (checkedOptions.length === totalOptions) {
                multiselectSelectAll.checked = true;
                multiselectSelectAll.indeterminate = false;
            } else if (checkedOptions.length > 0) {
                multiselectSelectAll.checked = false;
                multiselectSelectAll.indeterminate = true;
            } else {
                multiselectSelectAll.checked = false;
                multiselectSelectAll.indeterminate = false;
            }
        }

        /**
         * Resetea el multiselect a su estado inicial.
         */
        function resetMultiselect() {
            multiselectDropdown.querySelectorAll('.multiselect-option:checked').forEach(cb => {
                cb.checked = false;
            });
            multiselectSearch.value = '';
            filterMultiselectOptions();
            updateMultiselectLabelAndSelectAll();
        }

        /**
         * Filtra las opciones basadas en el input de búsqueda.
         */
        function filterMultiselectOptions() {
            const filter = multiselectSearch.value.toLowerCase();
            multiselectDropdown.querySelectorAll('.multiselect-option-container').forEach(container => {
                const label = container.querySelector('span').textContent.toLowerCase();
                if (label.includes(filter)) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });
        }

        // Listener para abrir/cerrar el dropdown
        multiselectButton.addEventListener('click', () => {
            multiselectDropdownContainer.classList.toggle('hidden');
            if (!multiselectDropdownContainer.classList.contains('hidden')) {
                // Auto-focus en el buscador al abrir
                multiselectSearch.focus();
            }
        });

        // Listener para cerrar el dropdown si se hace clic fuera de él
        document.addEventListener('click', (e) => {
            if (!multiselectButton.contains(e.target) && !multiselectDropdownContainer.contains(e.target)) {
                multiselectDropdownContainer.classList.add('hidden');
            }
        });

        // Listener para el buscador
        multiselectSearch.addEventListener('input', filterMultiselectOptions);

        // Listener para "Seleccionar todo"
        multiselectSelectAll.addEventListener('change', () => {
            // Seleccionar solo los visibles (filtrados)
            multiselectDropdown.querySelectorAll('.multiselect-option-container').forEach(container => {
                if (!container.classList.contains('hidden')) {
                    container.querySelector('.multiselect-option').checked = multiselectSelectAll.checked;
                }
            });
            updateMultiselectLabelAndSelectAll();
        });

        // Poblar el multiselect al inicio
        populateMultiselect();

        // --- FIN: Lógica Multiselect ---

    </script>
</body>
</html>